#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo_info() {
    echo -e "${BLUE}INFO:${NC} $1"
}

echo_success() {
    echo -e "${GREEN}SUCCESS:${NC} $1"
}

echo_error() {
    echo -e "${RED}ERROR:${NC} $1"
}

# Detect OS and Architecture
OS="$(uname -s)"
ARCH="$(uname -m)"

BINARY_NAME=""
TARGET_OS=""

case "$OS" in
    Darwin)
        TARGET_OS="macos"
        if [ "$ARCH" = "arm64" ]; then
            BINARY_NAME="simple-cli-macos-silicon"
        else
            BINARY_NAME="simple-cli-macos"
        fi
        ;;
    Linux)
        TARGET_OS="linux"
        if [ "$ARCH" = "aarch64" ]; then
            BINARY_NAME="simple-cli-linux-arm64"
        else
            BINARY_NAME="simple-cli-linux"
        fi
        ;;
    MINGW*|MSYS*|CYGWIN*)
        TARGET_OS="windows"
        BINARY_NAME="simple-cli-windows.exe"
        ;;
    *)
        echo_error "Unsupported operating system: $OS"
        exit 1
        ;;
esac

echo_info "Detected platform: $OS ($ARCH)"
echo_info "Target binary: $BINARY_NAME"

# Define install paths
INSTALL_DIR="$HOME/.simple/bin"
BINARY_PATH="$INSTALL_DIR/simple"

# Create install directory
mkdir -p "$INSTALL_DIR"

# Download URL
DOWNLOAD_URL="https://github.com/simple-platform/simple-tools/releases/latest/download/$BINARY_NAME"

echo_info "Downloading simple cli..."

# Download the binary
if command -v curl >/dev/null 2>&1; then
    curl -fsSL "$DOWNLOAD_URL" -o "$BINARY_PATH"
elif command -v wget >/dev/null 2>&1; then
    wget -qO "$BINARY_PATH" "$DOWNLOAD_URL"
else
    echo_error "Neither curl nor wget found. Please install one of them to proceed."
    exit 1
fi

# Make executable
chmod +x "$BINARY_PATH"

echo_success "Installed simple-cli to $BINARY_PATH"

# Setup PATH
SHELL_NAME=$(basename "$SHELL")
PROFILE_FILE=""

case "$SHELL_NAME" in
    zsh)
        PROFILE_FILE="$HOME/.zshrc"
        ;;
    bash)
        if [ "$OS" = "Darwin" ]; then
            PROFILE_FILE="$HOME/.bash_profile"
        else
            PROFILE_FILE="$HOME/.bashrc"
        fi
        ;;
    fish)
        PROFILE_FILE="$HOME/.config/fish/config.fish"
        ;;
    *)
        # Fallback for other shells or if detection fails
        if [ -f "$HOME/.profile" ]; then
            PROFILE_FILE="$HOME/.profile"
        elif [ -f "$HOME/.bash_profile" ]; then
            PROFILE_FILE="$HOME/.bash_profile"
        elif [ -f "$HOME/.bashrc" ]; then
            PROFILE_FILE="$HOME/.bashrc"
        fi
        ;;
esac

# Special handling for Git Bash on Windows
if [[ "$OS" == MINGW* ]] || [[ "$OS" == MSYS* ]] || [[ "$OS" == CYGWIN* ]]; then
    if [ -f "$HOME/.bash_profile" ]; then
        PROFILE_FILE="$HOME/.bash_profile"
    else
        PROFILE_FILE="$HOME/.bashrc"
    fi
fi

if [ -n "$PROFILE_FILE" ]; then
    if grep -q "$INSTALL_DIR" "$PROFILE_FILE"; then
        echo_info "PATH already configured in $PROFILE_FILE"
    else
        echo_info "Adding $INSTALL_DIR to PATH in $PROFILE_FILE"
        echo >> "$PROFILE_FILE"
        echo "# simple-cli" >> "$PROFILE_FILE"
        if [[ "$SHELL_NAME" == "fish" ]]; then
            echo "set -gx PATH \"$INSTALL_DIR\" \$PATH" >> "$PROFILE_FILE"
        else
            echo "export PATH=\"$INSTALL_DIR:\$PATH\"" >> "$PROFILE_FILE"
        fi
        echo_success "Added to PATH. Please restart your shell or run: source $PROFILE_FILE"
    fi
else
    echo_info "Could not detect shell profile file."
    echo_info "Please add the following to your shell configuration manually:"
    echo "export PATH=\"$INSTALL_DIR:\$PATH\""
fi

echo_success "Installation complete! Run 'simple --help' to get started."
