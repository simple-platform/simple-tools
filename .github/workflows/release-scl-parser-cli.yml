name: Release SCL Parser CLI

on:
  pull_request:
    branches:
      - main
    paths:
      - 'tools/scl_parser_cli/**'
      - '.github/workflows/release-scl-parser-cli.yml'
  workflow_dispatch:
    inputs:
      confirm_release:
        description: 'Create a release PR with version bump and changelog'
        required: true
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      
      - name: Set up Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1
        with:
          elixir-version: '1.18.1'
          otp-version: '27.2'
      
      - name: Install Dependencies
        run: |
          cd tools/scl_parser_cli
          mix deps.get
          
      - name: Run Tests
        run: |
          cd tools/scl_parser_cli
          mix test --no-start

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      
      - name: Set up Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1
        with:
          elixir-version: '1.18.1'
          otp-version: '27.2'
      
      - name: Install Dependencies
        run: |
          cd tools/scl_parser_cli
          mix deps.get
          
      - name: Compile
        run: |
          cd tools/scl_parser_cli
          MIX_ENV=prod mix compile --warnings-as-errors

  # Binary builds - only runs on manual trigger for releases
  build_binaries:
    name: Build Binary (${{ matrix.target }})
    needs: [test, build]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [macos, macos_silicon, linux, linux_arm, windows]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      
      - name: Set up Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1
        with:
          elixir-version: '1.18.1'
          otp-version: '27.2'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xz-utils

      - name: Set up Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2
      
      - name: Install Dependencies
        run: |
          cd tools/scl_parser_cli
          mix deps.get
          
      - name: Build Release
        env:
          BURRITO_TARGET: ${{ matrix.target }}
          MIX_ENV: prod
        run: |
          cd tools/scl_parser_cli
          mix release --overwrite
          
          # Rename binary to match strict naming convention
          cd burrito_out
          
          # Determine extension (Windows uses .exe)
          EXT=""
          if [[ "${{ matrix.target }}" == "windows" ]]; then
            EXT=".exe"
          fi
          
          # Target name mapping (linux_arm -> linux-arm64)
          TARGET_NAME="${{ matrix.target }}"
          if [[ "$TARGET_NAME" == "linux_arm" ]]; then
            TARGET_NAME="linux-arm64"
          fi
          if [[ "$TARGET_NAME" == "macos_silicon" ]]; then
            TARGET_NAME="macos-silicon"
          fi
          
          # Find the generated binary (usually matches app name 'scl_parser_cli' or similar)
          # We'll rename specifically to the target name requested
          src_bin=$(find . -maxdepth 1 -type f -not -name ".*" | head -n 1)
          if [ -f "$src_bin" ]; then
             mv "$src_bin" "scl-parser-${TARGET_NAME}${EXT}"
          fi
          cd ..

      - name: Upload Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: binary-${{ matrix.target }}
          path: tools/scl_parser_cli/burrito_out/*
          retention-days: 30

  # Release PR creation - only runs on manual trigger
  create_release_pr:
    name: Create Release PR
    needs: [test, build, build_binaries]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Calculate Version
        id: version
        uses: paulhatch/semantic-version@a8f8f59fd7f0625188492e945240f12d7ad2dca3 # v5.4.0
        with:
          tag_prefix: v
          major_pattern: '/(BREAKING CHANGE|!:)/'
          minor_pattern: '/feat\\(scl-parser-cli\\):/'
          version_format: '${major}.${minor}.${patch}'
          change_path: tools/scl_parser_cli
          namespace: scl-parser-cli
          bump_each_commit: false
          search_commit_body: true
          enable_prerelease_mode: false

      - name: Download All Artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          path: artifacts
          pattern: binary-*
          merge-multiple: true

      - name: Generate Changelog
        id: changelog
        env:
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_TAG: ${{ steps.version.outputs.version_tag }}
        run: |
          # Get the previous tag for this package
          PREV_TAG=$(git tag -l "v*-scl-parser-cli" --sort=-version:refname | head -n 1)

          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"* %s (%h)%n%b" --grep="(scl-parser-cli)" -- tools/scl_parser_cli)
          else
            COMMITS=$(git log "${PREV_TAG}..HEAD" --pretty=format:"* %s (%h)%n%b" --grep="(scl-parser-cli)" -- tools/scl_parser_cli)
          fi

          FEATURES=$(echo "$COMMITS" | grep "feat(scl-parser-cli):" | head -n 1 || true)
          # Note: Simple grep on subject lines might need cleaner output if bodies are mixed in.
          # Let's separate the retrieval.
          
          # 1. Get Subjects for lists
          if [ -z "$PREV_TAG" ]; then
            SUBJECTS=$(git log --pretty=format:"* %s (%h)" --grep="(scl-parser-cli)" -- tools/scl_parser_cli)
          else
            SUBJECTS=$(git log "${PREV_TAG}..HEAD" --pretty=format:"* %s (%h)" --grep="(scl-parser-cli)" -- tools/scl_parser_cli)
          fi
          
          FEATURES=$(echo "$SUBJECTS" | grep "feat(scl-parser-cli):" || true)
          FIXES=$(echo "$SUBJECTS" | grep "fix(scl-parser-cli):" || true)
          OTHER=$(echo "$SUBJECTS" | grep -v -E "feat\(scl-parser-cli\):|fix\(scl-parser-cli\):|ci\(scl-parser-cli\):" | grep -v "^$" || true)

          # 2. Get Breaking Changes (Subject OR Body)
          if [ -z "$PREV_TAG" ]; then
             BREAKING_RAW=$(git log --pretty=format:"%s%n%b" --grep="BREAKING CHANGE" --grep="!:" -- tools/scl_parser_cli)
          else
             BREAKING_RAW=$(git log "${PREV_TAG}..HEAD" --pretty=format:"%s%n%b" --grep="BREAKING CHANGE" --grep="!:" -- tools/scl_parser_cli)
          fi
          
          # Clean up breaking changes to be one-liners or just list the commits
          if [ -n "$BREAKING_RAW" ]; then
             BREAKING=$(echo "$BREAKING_RAW" | grep "BREAKING CHANGE" | sed 's/BREAKING CHANGE: //g' || true)
             # Fallback if the grep misses (e.g. !:)
             if [ -z "$BREAKING" ]; then
                BREAKING="Contains breaking changes. See commit history."
             fi
          else
             BREAKING=""
          fi

          # Build changelog content
          {
            echo "## SCL Parser CLI ${VERSION}"
            echo ""
            
            if [ -n "$BREAKING" ]; then
              echo "### âš ï¸ Breaking Changes"
              echo "$BREAKING"
              echo ""
            fi

            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features"
              echo "$FEATURES"
              echo ""
            fi

            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            
            if [ -n "$OTHER" ]; then
              echo "### ðŸ“ Other Changes"
              echo "$OTHER"
              echo ""
            fi
          } > /tmp/changelog_section.md

          # Output to Step Summary
          echo "## ðŸš€ Release Version: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "Tag: ${VERSION_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changelog Preview" >> $GITHUB_STEP_SUMMARY
          cat /tmp/changelog_section.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -la artifacts/ >> $GITHUB_STEP_SUMMARY

      - name: Upload Binaries for Publish Workflow
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: release-binaries-${{ steps.version.outputs.version }}
          path: artifacts/*
          retention-days: 30

      - name: Create Release PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_TAG: ${{ steps.version.outputs.version_tag }}
        run: |
          BRANCH="release/scl-parser-cli-v${VERSION}"
          
          # Configure git
          git config --local user.email "154070804+simple-platform-devops@users.noreply.github.com"
          git config --local user.name "Simple DevOps"
          
          # Create and checkout new branch
          git checkout -b "$BRANCH"
          
          cd tools/scl_parser_cli
          
          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to SCL Parser CLI will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # Insert new changelog section
          awk -v section="$(cat /tmp/changelog_section.md)" '
            /^## / && !inserted {
              print section
              print ""
              inserted=1
            }
            { print }
            END { if (!inserted) print section }
          ' CHANGELOG.md > CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md
          
          # Update mix.exs version
          sed -i "s/version: \"[0-9]*\.[0-9]*\.[0-9]*\"/version: \"${VERSION}\"/" mix.exs
          
          # Update package.json version
          sed -i "s/\"version\": \"[0-9]*\.[0-9]*\.[0-9]*\"/\"version\": \"${VERSION}\"/" package.json
          
          # Stage changes
          git add CHANGELOG.md mix.exs package.json
          
          # Only create PR if there are staged changes
          if git diff --cached --quiet; then
            echo "No changes to commit; skipping PR creation."
            exit 0
          fi
          
          git commit -m "chore(scl-parser-cli): release version ${VERSION}"
          git push origin "$BRANCH"
          
          # Build PR body
          {
            echo "## ðŸš€ Release SCL Parser CLI v${VERSION}"
            echo ""
            echo "This PR was automatically created by the release workflow."
            echo ""
            echo "### Version Info"
            echo "- **New Version**: ${VERSION}"
            echo "- **Tag**: ${VERSION_TAG}"
            echo ""
            echo "### Changelog"
            echo ""
            cat /tmp/changelog_section.md
            echo ""
            echo "### Build Artifacts"
            echo "The following binaries were built and are ready for release:"
            echo "- \`scl-parser-cli-macos\` (macOS x86_64)"
            echo "- \`scl-parser-cli-macos-silicon\` (macOS ARM64)"
            echo "- \`scl-parser-cli-linux\` (Linux x86_64)"
            echo "- \`scl-parser-cli-linux-arm\` (Linux ARM64)"
            echo "- \`scl-parser-cli-windows.exe\` (Windows x86_64)"
            echo ""
            echo "---"
            echo ""
            echo "### Files Changed"
            echo "- \`mix.exs\` - version bump to ${VERSION}"
            echo "- \`package.json\` - version bump to ${VERSION}"
            echo "- \`CHANGELOG.md\` - release notes added"
            echo ""
            echo "> **Note**: Merging this PR will trigger the publish workflow to create the tag and GitHub release with binaries."
          } > /tmp/pr-body.md
          
          # Create PR
          gh pr create \
            --title "chore(scl-parser-cli): release version ${VERSION}" \
            --body-file /tmp/pr-body.md \
            --base main \
            --head "$BRANCH"
