name: Release Simple CLI

on:
  workflow_dispatch:
    inputs:
      confirm_release:
        description: 'Create a release PR with version bump and changelog'
        required: true
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: '1.25.7'

      - name: Lint
        uses: golangci/golangci-lint-action@55c2c1448f86e01eaae002a5a3a9624417608d84 # v6.5.2
        with:
          version: v2.8.0
          working-directory: tools/simple-cli

      - name: Run Tests
        run: |
          cd tools/simple-cli
          go test -v ./...

  prepare:
    name: Prepare Release
    needs: test
    if: github.event.inputs.confirm_release == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Calculate Version
        id: version
        uses: paulhatch/semantic-version@a8f8f59fd7f0625188492e945240f12d7ad2dca3 # v5.4.0
        with:
          tag_prefix: v
          major_pattern: '/(\\(simple-cli\\).*!)|BREAKING CHANGE/'
          minor_pattern: '/feat\\(simple-cli\\):/'
          version_format: '${major}.${minor}.${patch}'
          change_path: tools/simple-cli
          namespace: simple-cli
          bump_each_commit: false
          search_commit_body: true
          enable_prerelease_mode: false

  build_binaries:
    name: Build Binary (${{ matrix.target }})
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: macos
            goos: darwin
            goarch: amd64
          - target: macos-silicon
            goos: darwin
            goarch: arm64
          - target: linux
            goos: linux
            goarch: amd64
          - target: linux-arm64
            goos: linux
            goarch: arm64
          - target: windows
            goos: windows
            goarch: amd64
            ext: .exe
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: '1.25.7'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          cd tools/simple-cli
          EXTENSION="${{ matrix.ext }}"
          
          # Inject the calculated version
          LDFLAGS="-s -w -X simple-cli/internal/cli.Version=${VERSION}"
          
          go build -ldflags="$LDFLAGS" -o "bin/simple${EXTENSION}" ./cmd/simple
          
          # Rename to final artifact name
          mv "bin/simple${EXTENSION}" "../simple-cli-${{ matrix.target }}${EXTENSION}"

      - name: Upload Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: binary-${{ matrix.target }}
          path: tools/simple-cli-${{ matrix.target }}${{ matrix.ext }}
          retention-days: 1

  create_release_pr:
    name: Create Release PR
    needs: [prepare, build_binaries]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      # Version is already calculated in prepare job
      
      - name: Generate Changelog
        id: changelog
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          PREV_TAG=$(git tag -l "v*-simple-cli" --sort=-version:refname | head -n 1)
          
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"* %s (%h)%n%b" --grep="(simple-cli)" -- tools/simple-cli)
          else
            COMMITS=$(git log "${PREV_TAG}..HEAD" --pretty=format:"* %s (%h)%n%b" --grep="(simple-cli)" -- tools/simple-cli)
          fi

          FEATURES=$(echo "$COMMITS" | grep "feat(simple-cli):" | head -n 1 || true)
          # Note: Simple grep on subject lines might need cleaner output if bodies are mixed in.
          # Let's separate the retrieval.
          
          # 1. Get Subjects for lists
          if [ -z "$PREV_TAG" ]; then
            SUBJECTS=$(git log --pretty=format:"* %s (%h)" --grep="(simple-cli)" -- tools/simple-cli)
          else
            SUBJECTS=$(git log "${PREV_TAG}..HEAD" --pretty=format:"* %s (%h)" --grep="(simple-cli)" -- tools/simple-cli)
          fi
          
          FEATURES=$(echo "$SUBJECTS" | grep "feat(simple-cli):" || true)
          FIXES=$(echo "$SUBJECTS" | grep "fix(simple-cli):" || true)
          OTHER=$(echo "$SUBJECTS" | grep -v -E "feat\(simple-cli\):|fix\(simple-cli\):|ci\(simple-cli\):" | grep -v "^$" || true)

          # 2. Get Breaking Changes (Subject OR Body)
          if [ -z "$PREV_TAG" ]; then
             BREAKING_RAW=$(git log --pretty=format:"%s%n%b" --grep="BREAKING CHANGE" --grep="!:" -- tools/simple-cli)
          else
             BREAKING_RAW=$(git log "${PREV_TAG}..HEAD" --pretty=format:"%s%n%b" --grep="BREAKING CHANGE" --grep="!:" -- tools/simple-cli)
          fi
          
          # Clean up breaking changes to be one-liners or just list the commits
          if [ -n "$BREAKING_RAW" ]; then
             BREAKING=$(echo "$BREAKING_RAW" | grep "BREAKING CHANGE" | sed 's/BREAKING CHANGE: //g' || true)
             # Fallback if the grep misses (e.g. !:)
             if [ -z "$BREAKING" ]; then
                BREAKING="Contains breaking changes. See commit history."
             fi
          else
             BREAKING=""
          fi

          {
            echo "## Simple CLI ${VERSION}"
            echo ""
            if [ -n "$BREAKING" ]; then echo "### âš ï¸ Breaking Changes"; echo "$BREAKING"; echo ""; fi
            if [ -n "$FEATURES" ]; then echo "### âœ¨ Features"; echo "$FEATURES"; echo ""; fi
            if [ -n "$FIXES" ]; then echo "### ðŸ› Bug Fixes"; echo "$FIXES"; echo ""; fi
            if [ -n "$OTHER" ]; then echo "### ðŸ“ Other Changes"; echo "$OTHER"; echo ""; fi
          } > /tmp/changelog_section.md

          cat /tmp/changelog_section.md >> $GITHUB_STEP_SUMMARY

      - name: Create Release PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          BRANCH="release/simple-cli-v${VERSION}"
          
          git config --local user.email "154070804+simple-platform-devops@users.noreply.github.com"
          git config --local user.name "Simple DevOps"
          
          git checkout -b "$BRANCH"
          
          cd tools/simple-cli
          
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to Simple CLI will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          awk -v section="$(cat /tmp/changelog_section.md)" '
            /^## / && !inserted { print section; print ""; inserted=1 }
            { print }
            END { if (!inserted) print section }
          ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
          
          # Update package.json version
          sed -i "s/\"version\": \"[0-9]*\.[0-9]*\.[0-9]*\"/\"version\": \"${VERSION}\"/" package.json
          
          git add CHANGELOG.md package.json
          
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          
          git commit -m "chore(simple-cli): release version ${VERSION}"
          git push origin "$BRANCH"
          
          gh pr create \
            --title "chore(simple-cli): release version ${VERSION}" \
            --body-file /tmp/changelog_section.md \
            --base main \
            --head "$BRANCH"
