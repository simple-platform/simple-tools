name: Release SCL Parser Library

on:
  pull_request:
    branches:
      - main
    paths:
      - 'packages/scl_parser/**'
      - '.github/workflows/release-scl-parser.yml'
  push:
    branches:
      - main
    paths:
      - 'packages/scl_parser/**'
      - '.github/workflows/release-scl-parser.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  preview:
    name: Preview Version & Changelog
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_tag: ${{ steps.version.outputs.version_tag }}
      changed: ${{ steps.version.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Calculate Version
        id: version
        uses: paulhatch/semantic-version@a8f8f59fd7f0625188492e945240f12d7ad2dca3 # v5.4.0
        with:
          tag_prefix: v
          major_pattern: '/(\\(scl-parser\\).*!)|BREAKING CHANGE/'
          minor_pattern: '/feat\\(scl-parser\\):/'
          version_format: '${major}.${minor}.${patch}'
          change_path: packages/scl_parser
          namespace: scl-parser
          bump_each_commit: false
          search_commit_body: true
          enable_prerelease_mode: false

      - name: Generate Changelog
        if: steps.version.outputs.changed == 'true'
        run: |
          # Get the previous tag for this package
          PREV_TAG=$(git tag -l "v*-scl-parser" --sort=-version:refname | head -n 1)

          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"* %s (%h)" --grep="(scl-parser)" -- packages/scl_parser)
          else
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"* %s (%h)" --grep="(scl-parser)" -- packages/scl_parser)
          fi

          # Organize commits by type
          FEATURES=$(echo "$COMMITS" | grep "feat(scl-parser):" || true)
          FIXES=$(echo "$COMMITS" | grep "fix(scl-parser):" || true)
          BREAKING=$(echo "$COMMITS" | grep -E "(feat|fix)\\(scl-parser\\)!:|BREAKING CHANGE" || true)
          OTHER=$(echo "$COMMITS" | grep -v -E "feat\\(scl-parser\\):|fix\\(scl-parser\\):" || true)

          # Build changelog
          echo "## SCL Parser ${{ steps.version.outputs.version }}" > changelog.md
          echo "" >> changelog.md

          if [ -n "$BREAKING" ]; then
            echo "### âš ï¸ Breaking Changes" >> changelog.md
            echo "$BREAKING" >> changelog.md
            echo "" >> changelog.md
          fi

          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ Features" >> changelog.md
            echo "$FEATURES" >> changelog.md
            echo "" >> changelog.md
          fi

          if [ -n "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes" >> changelog.md
            echo "$FIXES" >> changelog.md
            echo "" >> changelog.md
          fi
          
          if [ -n "$OTHER" ]; then
            echo "### ðŸ“ Other Changes" >> changelog.md
            echo "$OTHER" >> changelog.md
            echo "" >> changelog.md
          fi

          # Output to Step Summary
          echo "## ðŸš€ Next Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Tag: ${{ steps.version.outputs.version_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changelog Preview" >> $GITHUB_STEP_SUMMARY
          cat changelog.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Changelog
        if: steps.version.outputs.changed == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: changelog
          path: changelog.md
          retention-days: 1

  test:
    name: Run Tests
    needs: preview
    if: needs.preview.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: Set up Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1
        with:
          elixir-version: '1.18.1'
          otp-version: '27.2'
      
      - name: Install Dependencies
        run: |
          cd packages/scl_parser
          mix deps.get
          
      - name: Run Tests
        run: |
          cd packages/scl_parser
          mix test

  publish_hex:
    name: Publish to Hex
    needs: [test, preview]
    if: needs.preview.outputs.changed == 'true' && (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: Set up Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1
        with:
          elixir-version: '1.18.1'
          otp-version: '27.2'
      
      - name: Install Dependencies
        run: |
          cd packages/scl_parser
          mix deps.get
          
      - name: Publish to Hex
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
        run: |
          cd packages/scl_parser
          mix hex.publish --yes

  release:
    name: GitHub Release
    needs: [test, preview]
    if: needs.preview.outputs.changed == 'true' && (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          
      - name: Download Changelog
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: changelog

      - name: Create Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          tag_name: ${{ needs.preview.outputs.version_tag }}
          name: SCL Parser ${{ needs.preview.outputs.version }}
          body_path: changelog.md
          draft: false
          prerelease: false

      - name: Update Repository
        run: |
          cd packages/scl_parser
          
          # Update CHANGELOG.md
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to SCL Parser will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # Prepend new changelog
          cat $GITHUB_WORKSPACE/changelog.md CHANGELOG.md > CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md
          
          # Update mix.exs version
          sed -i 's/version: "[0-9]*\.[0-9]*\.[0-9]*"/version: "${{ needs.preview.outputs.version }}"/' mix.exs
          
          # Commit and Push
          git config --local user.email "154070804+simple-platform-devops@users.noreply.github.com"
          git config --local user.name "Simple DevOps"
          git add CHANGELOG.md mix.exs
          
          # Only commit and push if there are staged changes
          if git diff --cached --quiet; then
            echo "No changes to commit; skipping commit and push."
          else
            git commit -m "chore(scl-parser): release version ${{ needs.preview.outputs.version }} [skip ci]"
            git push origin HEAD:main
          fi
