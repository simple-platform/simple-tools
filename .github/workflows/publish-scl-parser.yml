name: Publish SCL Parser

on:
  push:
    branches:
      - main
    paths:
      - 'packages/scl_parser/mix.exs'
      - 'packages/scl_parser/CHANGELOG.md'

permissions:
  contents: read

jobs:
  check_release_commit:
    name: Check Release Commit
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check Commit Message
        id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          # Check if this is a release commit from our workflow
          if echo "$COMMIT_MSG" | grep -qE "^chore\(scl-parser\): release version [0-9]+\.[0-9]+\.[0-9]+"; then
            VERSION=$(echo "$COMMIT_MSG" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" | head -1)
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "âœ… Release commit detected: v${VERSION}"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Not a release commit, skipping publish"
          fi

  publish:
    name: Tag, Publish & Release
    needs: check_release_commit
    if: needs.check_release_commit.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Create Tag
        env:
          VERSION: ${{ needs.check_release_commit.outputs.version }}
        run: |
          TAG="v${VERSION}-scl-parser"
          
          git config --local user.email "154070804+simple-platform-devops@users.noreply.github.com"
          git config --local user.name "Simple DevOps"
          
          git tag -a "$TAG" -m "SCL Parser v${VERSION}"
          git push origin "$TAG"
          
          echo "## ðŸ·ï¸ Created Tag: ${TAG}" >> $GITHUB_STEP_SUMMARY

      - name: Set up Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1
        with:
          elixir-version: '1.18.1'
          otp-version: '27.2'
      
      - name: Install Dependencies
        run: |
          cd packages/scl_parser
          mix deps.get
          
      - name: Publish to Hex
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
        run: |
          cd packages/scl_parser
          mix hex.publish --yes
          echo "## ðŸ“¦ Published to Hex.pm" >> $GITHUB_STEP_SUMMARY

      - name: Extract Changelog for Release
        id: changelog
        env:
          VERSION: ${{ needs.check_release_commit.outputs.version }}
        run: |
          cd packages/scl_parser
          
          # Extract this version's changelog section from CHANGELOG.md
          # The section starts with "## SCL Parser X.Y.Z" and ends before the next "## " or EOF
          # Use awk to extract the section properly
          
          awk -v ver="$VERSION" '
            BEGIN { printing=0 }
            /^## SCL Parser / {
              if (printing) exit
              if ($0 == "## SCL Parser " ver) {
                printing=1
                print
                next
              }
            }
            /^## / && printing { exit }
            printing { print }
          ' CHANGELOG.md > /tmp/release-notes.md
          
          # Check if we got content
          if [ ! -s /tmp/release-notes.md ]; then
            echo "Warning: Could not extract changelog section, generating from git log"
            
            # Fallback: generate release notes from recent commits
            PREV_TAG=$(git tag -l "v*-scl-parser" --sort=-version:refname | grep -v "v${VERSION}-scl-parser" | head -n 1)
            
            {
              echo "## SCL Parser ${VERSION}"
              echo ""
              
              if [ -z "$PREV_TAG" ]; then
                COMMITS=$(git log --pretty=format:"* %s (%h)" --grep="(scl-parser)" -- . | head -20)
              else
                COMMITS=$(git log "${PREV_TAG}..HEAD" --pretty=format:"* %s (%h)" --grep="(scl-parser)" -- . | head -20)
              fi
              
              FEATURES=$(echo "$COMMITS" | grep "feat(scl-parser):" || true)
              FIXES=$(echo "$COMMITS" | grep "fix(scl-parser):" || true)
              OTHER=$(echo "$COMMITS" | grep -v -E "feat\(scl-parser\):|fix\(scl-parser\):" | grep -v "^$" || true)
              
              if [ -n "$FEATURES" ]; then
                echo "### âœ¨ Features"
                echo "$FEATURES"
                echo ""
              fi
              
              if [ -n "$FIXES" ]; then
                echo "### ðŸ› Bug Fixes"
                echo "$FIXES"
                echo ""
              fi
              
              if [ -n "$OTHER" ]; then
                echo "### ðŸ“ Other Changes"
                echo "$OTHER"
                echo ""
              fi
            } > /tmp/release-notes.md
          fi
          
          # Show what we're using for release notes
          echo "### ðŸ“‹ Release Notes Preview" >> $GITHUB_STEP_SUMMARY
          cat /tmp/release-notes.md >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        env:
          VERSION: ${{ needs.check_release_commit.outputs.version }}
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: v${{ needs.check_release_commit.outputs.version }}-scl-parser
          name: SCL Parser ${{ needs.check_release_commit.outputs.version }}
          body_path: /tmp/release-notes.md
          draft: false
          prerelease: false
